<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¢¨éšªè©•ä¼°çµæœ - MRONJé¢¨éšªè©•ä¼°</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    @media print {
      body {
        padding: 20px;
        font-family: "Microsoft JhengHei", sans-serif;
      }
      
      .no-print {
        display: none !important;
      }
      
      .container {
        max-width: 100%;
        margin: 0;
        padding: 0;
      }
      
      .assessment-card {
        break-inside: avoid;
        page-break-inside: avoid;
        margin-bottom: 20px;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
      }
      
      .risk-badge {
        padding: 5px 10px;
        border-radius: 15px;
        font-weight: bold;
      }
      
      .risk-badge.high-risk {
        background-color: #FF3B30 !important;
        color: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      .risk-badge.midhigh-risk {
        background-color: #FF7043 !important; /* between medium (orange) and high (red) */
        color: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      .risk-badge.medium-risk {
        background-color: #FF9500 !important;
        color: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      .risk-badge.midlow-risk {
        background-color: #8BC34A !important; /* between low (green) and medium (orange) */
        color: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      .risk-badge.low-risk {
        background-color: #34C759 !important;
        color: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      .risk-badge.unknown-risk {
        background-color: #6c757d !important;
        color: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      .summary-section {
        margin-bottom: 30px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      
      .summary-item {
        margin-bottom: 10px;
      }
      
      .page-header {
        text-align: center;
        margin-bottom: 30px;
      }
      
      .page-footer {
        position: fixed;
        bottom: 0;
        width: 100%;
        text-align: center;
        font-size: 12px;
        padding: 10px;
        border-top: 1px solid #ddd;
      }
      
      .disclaimer {
        margin-top: 30px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 12px;
        page-break-inside: avoid;
      }
      
      .hygiene-section,
      .semi-invasive-section,
      .invasive-section {
        break-inside: avoid;
        page-break-inside: avoid;
        margin-bottom: 20px;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      .hygiene-section {
        background-color: #e8f5e9 !important;
        border-left: 4px solid #4caf50 !important;
      }
      
      .semi-invasive-section {
        background-color: #fff3e0 !important;
        border-left: 4px solid #ff9800 !important;
      }
      
      .invasive-section {
        background-color: #ffebee !important;
        border-left: 4px solid #f44336 !important;
      }
      
      .references-section {
        break-inside: avoid;
        page-break-inside: avoid;
        margin-bottom: 20px;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
        background-color: #f5f5f5 !important;
        border-left: 4px solid #757575 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    }
    
    .assessment-card {
      background-color: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .risk-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 15px;
      color: white;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .risk-badge.high-risk {
      background-color: #FF3B30;
    }
    .risk-badge.midhigh-risk {
      background-color: #FF7043;
    }
    
    .risk-badge.medium-risk {
      background-color: #FF9500;
    }
    
    .risk-badge.midlow-risk {
      background-color: #8BC34A;
    }
    
    .risk-badge.low-risk {
      background-color: #34C759;
    }
    
    .risk-badge.unknown-risk {
      background-color: #6c757d;
    }
    
    .summary-section {
      background-color: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .summary-item {
      margin-bottom: 10px;
    }
    
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }
    
    .btn {
      padding: 12px 20px;
      border-radius: 5px;
      border: none;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      min-width: 150px;
      text-align: center;
      text-decoration: none;
    }
    
    .btn-primary {
      background-color: #007AFF;
      color: white;
    }
    
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="page-header">
      <h1 class="zh-text">MRONJé¢¨éšªè©•ä¼°çµæœ</h1>
      <h1 class="en-text" style="display: none;">MRONJ Risk Assessment Results</h1>
      <p class="zh-text">æ ¹æ“šæä¾›çš„è³‡è¨Šï¼Œä»¥ä¸‹æ˜¯ä¸åŒç‰™ç§‘æ²»ç™‚çš„MRONJé¢¨éšªè©•ä¼°</p>
      <p class="en-text" style="display: none;">Based on your information, here is the MRONJ risk assessment for different dental treatments</p>
      <p class="evaluation-date zh-text">è©•ä¼°æ—¥æœŸï¼š<span id="current-date"></span></p>
      <p class="evaluation-date en-text" style="display: none;">Assessment Date: <span id="current-date-en"></span></p>
    </header>

    <main>
      <div id="patient-summary" class="summary-section">
        <h2 class="zh-text">æ‚£è€…è³‡è¨Šæ‘˜è¦</h2>
        <h2 class="en-text" style="display: none;">Patient Information Summary</h2>
        <div id="patient-info-summary"></div>
      </div>

      <div id="results-container" class="assessment-results">
        <!-- Results will be populated by JavaScript -->
        <div class="loading zh-text">è¨ˆç®—é¢¨éšªä¸­...</div>
        <div class="loading en-text" style="display: none;">Calculating risk...</div>
      </div>

      <div class="disclaimer">
        <p class="zh-text"><strong>å…è²¬è²æ˜ï¼š</strong></p>
        <p class="en-text" style="display: none;"><strong>Disclaimer:</strong></p>
        <p class="zh-text">æœ¬è©•ä¼°çµæœåƒ…ä¾›åƒè€ƒï¼Œä¸æ§‹æˆé†«ç™‚å»ºè­°ã€‚æœ€çµ‚æ²»ç™‚æ±ºç­–æ‡‰ç”±é†«ç™‚å°ˆæ¥­äººå“¡èˆ‡æ‚£è€…å…±åŒè¨è«–å¾Œæ±ºå®šã€‚</p>
        <p class="en-text" style="display: none;">This assessment result is for reference only and does not constitute medical advice. Final treatment decisions should be made after discussion between medical professionals and the patient.</p>
      </div>

      <div class="action-buttons no-print">
        <button id="print-btn" class="btn btn-primary zh-text">åˆ—å°è©•ä¼°å ±å‘Š</button>
        <button id="print-btn-en" class="btn btn-primary en-text" style="display: none;">Print Report</button>
        <a href="https://risch315815.github.io/MRONJ_WBPG/" class="btn btn-secondary zh-text">è¿”å›é¦–é </a>
        <a href="https://risch315815.github.io/MRONJ_WBPG/" class="btn btn-secondary en-text" style="display: none;">Return to Homepage</a>
      </div>
    </main>

    <footer class="page-footer">
      <p class="zh-text">MRONJé¢¨éšªè©•ä¼°å·¥å…· | ç‰ˆæœ¬ 1.0.0</p>
      <p class="en-text" style="display: none;">MRONJ Risk Assessment Tool | Version 1.0.0</p>
    </footer>
  </div>

  <script src="assets/js/mronj-references.js"></script>
  <script src="assets/js/mronj-risk-algorithm.js"></script>
  <script src="assets/js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Helper to (re)apply language visibility for dynamically inserted elements
      function applyLanguagePreference() {
        const lang = localStorage.getItem('preferredLanguage') || 'zh';
        const showZh = lang !== 'en';
        document.querySelectorAll('.zh-text').forEach(el => { el.style.display = showZh ? '' : 'none'; });
        document.querySelectorAll('.en-text').forEach(el => { el.style.display = showZh ? 'none' : ''; });
      }
      // Apply language preference from homepage
      const zhTexts = document.querySelectorAll('.zh-text');
      const enTexts = document.querySelectorAll('.en-text');
      
      // Get language preference from localStorage (set by homepage)
      const savedLang = localStorage.getItem('preferredLanguage') || 'zh';
      
      // Update lang attribute based on language preference
      if (savedLang === 'en') {
        document.documentElement.lang = 'en';
      } else {
        document.documentElement.lang = 'zh-TW';
      }
      
      // Show/hide text based on saved language preference
      if (savedLang === 'en') {
        zhTexts.forEach(text => text.style.display = 'none');
        enTexts.forEach(text => text.style.display = 'block');
      } else {
        zhTexts.forEach(text => text.style.display = 'block');
        enTexts.forEach(text => text.style.display = 'none');
      }
      // Ensure later dynamic content also reflects language
      const applyLangLater = () => applyLanguagePreference();
      // Set current date
      const today = new Date();
      const formattedDate = `${today.getFullYear()}å¹´${(today.getMonth() + 1).toString().padStart(2, '0')}æœˆ${today.getDate().toString().padStart(2, '0')}æ—¥`;
      const formattedDateEn = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
      document.getElementById('current-date').textContent = formattedDate;
      document.getElementById('current-date-en').textContent = formattedDateEn;
      
      // Check if patient data exists
      if (!patientData || !patientData.name) {
        const isEnglish = document.querySelector('.en-text') && 
                         window.getComputedStyle(document.querySelector('.en-text')).display !== 'none';
        alert(isEnglish ? 'Unable to retrieve patient data, please start the assessment from the beginning' : 'ç„¡æ³•å–å¾—æ‚£è€…è³‡æ–™ï¼Œè«‹å¾é ­é–‹å§‹å¡«å¯«è©•ä¼°è¡¨');
        window.location.href = 'index.html';
        return;
      }
      
      // Update document title with patient name (for print filename)
      const patientName = patientData.name || 'Patient';
      if (savedLang === 'en') {
        document.title = `MRONJ Risk Assessment Result - ${patientName}`;
      } else {
        document.title = `MRONJé¢¨éšªè©•ä¼°çµæœ - ${patientName}`;
      }
      
      // Display patient summary
      displayPatientSummary();
      applyLanguagePreference();
      
      // Calculate and display risk assessment
      try {
        const assessments = assessRisk();
        displayResults(assessments);
        applyLanguagePreference();
      } catch (e) {
        const resultsContainer = document.getElementById('results-container');
        resultsContainer.innerHTML = `<div style="color:#b71c1c;background:#ffebee;padding:12px;border-radius:6px;">Error calculating risk: ${e.message}</div>`;
        console.error('assessRisk failed:', e);
      }
      
      // Print button event
      const printBtnZh = document.getElementById('print-btn');
      const printBtnEn = document.getElementById('print-btn-en');
      if (printBtnZh) {
        printBtnZh.addEventListener('click', function() {
          window.print();
        });
      }
      if (printBtnEn) {
        printBtnEn.addEventListener('click', function() {
          window.print();
        });
      }
    });
    
    function displayPatientSummary() {
      const summaryContainer = document.getElementById('patient-info-summary');
      // Calculate BMI if height and weight are available
      let bmi = '';
      if (patientData.height && patientData.weight) {
        const heightInMeters = patientData.height / 100;
        bmi = (patientData.weight / (heightInMeters * heightInMeters)).toFixed(1);
      }
      // Determine language once for the whole function
      const isEnglish = (localStorage.getItem('preferredLanguage') || 'zh') === 'en';
      // Create summary HTML
      let summaryHTML = `
        <div class="summary-item zh-text"><strong>å§“å:</strong> ${patientData.name || '--'}</div>
        <div class="summary-item en-text" style="display: none;"><strong>Name:</strong> ${patientData.name || '--'}</div>
        <div class="summary-item zh-text"><strong>å¹´é½¡:</strong> ${patientData.age || '--'}</div>
        <div class="summary-item en-text" style="display: none;"><strong>Age:</strong> ${patientData.age || '--'}</div>
        <div class="summary-item zh-text"><strong>æ€§åˆ¥:</strong> ${patientData.gender === 'male' ? 'ç”·' : patientData.gender === 'female' ? 'å¥³' : 'å…¶ä»–'}</div>
        <div class="summary-item en-text" style="display: none;"><strong>Gender:</strong> ${patientData.gender === 'male' ? 'Male' : patientData.gender === 'female' ? 'Female' : 'Other'}</div>
        <div class="summary-item zh-text"><strong>èº«é«˜:</strong> ${patientData.height ? patientData.height + ' cm' : '--'}</div>
        <div class="summary-item en-text" style="display: none;"><strong>Height:</strong> ${patientData.height ? patientData.height + ' cm' : '--'}</div>
        <div class="summary-item zh-text"><strong>é«”é‡:</strong> ${patientData.weight ? patientData.weight + ' kg' : '--'}</div>
        <div class="summary-item en-text" style="display: none;"><strong>Weight:</strong> ${patientData.weight ? patientData.weight + ' kg' : '--'}</div>
        <div class="summary-item"><strong>BMI:</strong> ${bmi ? bmi : '--'}</div>
      `;
      // Translation function for medication details
      function translateMedicationDetails(med) {
        const indicationTranslations = {
          'éª¨è³ªç–é¬†': 'Osteoporosis',
          'å¤šç™¼æ€§éª¨é«“ç˜¤': 'Multiple Myeloma',
          'éª¨è½‰ç§»': 'Bone Metastasis of Cancer',
          'å…¶ä»–': 'Other'
        };
        
        const routeTranslations = {
          'å£æœ': 'Oral',
          'æ³¨å°„': 'Injection'
        };
        
        const frequencyTranslations = {
          'æ¯å¤©': 'Daily',
          'æ¯å€‹æœˆ': 'Monthly',
          'æ¯åŠå¹´': 'Every 6 months'
        };
        
        return {
          indication: indicationTranslations[med.indication] || med.indication,
          administrationRoute: routeTranslations[med.administrationRoute] || med.administrationRoute,
          frequency: frequencyTranslations[med.frequency] || med.frequency
        };
      }
      
      // Add medication info
      console.log('Patient data for summary:', patientData);
      console.log('hasAntiresorptiveMed:', patientData.hasAntiresorptiveMed);
      console.log('medications:', patientData.medications);
      if (patientData.hasAntiresorptiveMed && patientData.medications && patientData.medications.length > 0) {
        patientData.medications.forEach((med, idx) => {
          // Calculate duration
          let duration = '';
          if (med.startYear && med.startMonth) {
            const start = new Date(med.startYear, med.startMonth - 1);
            const end = med.isStopped && med.stopYear && med.stopMonth ? new Date(med.stopYear, med.stopMonth - 1) : new Date();
            const months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
            duration = isEnglish ? `approximately ${months} months` : `ç´„${months}å€‹æœˆ`;
          }
          
          // Get translated values
          const translated = translateMedicationDetails(med);
          
          summaryHTML += `
            <div class="summary-item" style="margin-top:10px;"><strong>${isEnglish ? 'Medication' : 'è—¥ç‰©'} ${patientData.medications.length > 1 ? idx + 1 : ''}:</strong></div>
            <div class="summary-item">${med.drugName || '--'}</div>
            <div class="summary-item zh-text">${med.indication || '--'} | ${med.administrationRoute || '--'} | ${med.frequency || '--'}</div>
            <div class="summary-item en-text" style="display: none;">${translated.indication || '--'} | ${translated.administrationRoute || '--'} | ${translated.frequency || '--'}</div>
            <div class="summary-item">${isEnglish ? 'Start:' : 'é–‹å§‹:'} ${med.startYear || '--'}${isEnglish ? '' : 'å¹´'}${med.startMonth || '--'}${isEnglish ? '' : 'æœˆ'}</div>
            <div class="summary-item">${med.isStopped ? (isEnglish ? `End: ${med.stopYear || '--'} ${med.stopMonth || '--'}` : `åœæ­¢: ${med.stopYear || '--'}å¹´${med.stopMonth || '--'}æœˆ`) : `<span style="color: #007AFF;">${isEnglish ? 'Currently Using' : 'æŒçºŒä½¿ç”¨ä¸­'}</span>`}</div>
            <div class="summary-item">${isEnglish ? 'Duration:' : 'ä½¿ç”¨æœŸé–“:'} ${duration || '--'}</div>
          `;
        });
      } else if (patientData.hasAntiresorptiveMed) {
        // Single medication (legacy fields)
        let duration = '';
        if (patientData.startYear && patientData.startMonth) {
          const start = new Date(patientData.startYear, patientData.startMonth - 1);
          const end = patientData.isStopped && patientData.stopYear && patientData.stopMonth ? new Date(patientData.stopYear, patientData.stopMonth - 1) : new Date();
          const months = (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth());
          duration = isEnglish ? `approximately ${months} months` : `ç´„${months}å€‹æœˆ`;
        }
        
        // Get translated values for legacy medication
        const legacyMed = {
          indication: patientData.indication,
          administrationRoute: patientData.administrationRoute,
          frequency: patientData.frequency
        };
        const translated = translateMedicationDetails(legacyMed);
        
        summaryHTML += `
          <div class="summary-item" style="margin-top:10px;"><strong>${isEnglish ? 'Medications:' : 'è—¥ç‰©:'}</strong></div>
          <div class="summary-item">${isEnglish ? 'Drug Name:' : 'è—¥ç‰©åç¨±:'} ${patientData.drugName || '--'}</div>
          <div class="summary-item zh-text">${isEnglish ? 'Indication:' : 'ä½¿ç”¨åŸå› :'} ${patientData.indication || '--'}</div>
          <div class="summary-item en-text" style="display: none;">${isEnglish ? 'Indication:' : 'ä½¿ç”¨åŸå› :'} ${translated.indication || '--'}</div>
          <div class="summary-item zh-text">${isEnglish ? 'Route:' : 'çµ¦è—¥é€”å¾‘:'} ${patientData.administrationRoute || '--'}</div>
          <div class="summary-item en-text" style="display: none;">${isEnglish ? 'Route:' : 'çµ¦è—¥é€”å¾‘:'} ${translated.administrationRoute || '--'}</div>
          <div class="summary-item zh-text">${isEnglish ? 'Frequency:' : 'ä½¿ç”¨é »ç‡:'} ${patientData.frequency || '--'}</div>
          <div class="summary-item en-text" style="display: none;">${isEnglish ? 'Frequency:' : 'ä½¿ç”¨é »ç‡:'} ${translated.frequency || '--'}</div>
          <div class="summary-item">${isEnglish ? 'Start Date:' : 'é–‹å§‹æ™‚é–“:'} ${patientData.startYear || '--'}${isEnglish ? '' : 'å¹´'}${patientData.startMonth || '--'}${isEnglish ? '' : 'æœˆ'}</div>
          <div class="summary-item">${patientData.isStopped ? 
            (isEnglish ? `End: ${patientData.stopYear || '--'} ${patientData.stopMonth || '--'}` : `åœæ­¢: ${patientData.stopYear || '--'}å¹´${patientData.stopMonth || '--'}æœˆ`) : 
            `<span style="color: #007AFF;">${isEnglish ? 'Currently Using' : 'æŒçºŒä½¿ç”¨ä¸­'}</span>`}</div>
          <div class="summary-item">${isEnglish ? 'Duration:' : 'ä½¿ç”¨æœŸé–“:'} ${duration || '--'}</div>
        `;
      } else {
        summaryHTML += `<div class="summary-item"><strong>${isEnglish ? 'Medication Status:' : 'ç”¨è—¥æƒ…æ³:'}</strong> ${isEnglish ? 'No related medications' : 'æœªä½¿ç”¨ç›¸é—œè—¥ç‰©'}</div>`;
      }
      // Add risk factors if any
      if (patientData.systemicDiseases && patientData.systemicDiseases.length > 0) {
        summaryHTML += `<div class="summary-item"><strong>${isEnglish ? 'Systemic Diseases:' : 'ç³»çµ±æ€§ç–¾ç—…:'}</strong> ${patientData.systemicDiseases.join(', ')}</div>`;
      }
      if (patientData.hasCancer) {
        summaryHTML += `<div class="summary-item"><strong>${isEnglish ? 'Cancer:' : 'ç™Œç—‡:'}</strong> ${isEnglish ? 'Yes' : 'æ˜¯'}</div>`;
      }
      if (patientData.hasRadiotherapy) {
        summaryHTML += `<div class="summary-item"><strong>${isEnglish ? 'Head & Neck Radiotherapy:' : 'é ­é ¸éƒ¨æ”¾å°„æ²»ç™‚:'}</strong> ${isEnglish ? 'Yes' : 'æ˜¯'}</div>`;
      }
      summaryContainer.innerHTML = summaryHTML;
    }
    
    // Display the risk assessment results
    function displayResults(assessments) {
      const resultsContainer = document.getElementById('results-container');
      resultsContainer.innerHTML = ''; // Clear loading message
      
      // Add a separator
      const separator = document.createElement('div');
      separator.className = 'section-divider';
      separator.style.cssText = 'border-top: 2px solid #ccc; margin: 30px 0;';
      resultsContainer.appendChild(separator);
      
      // Add a title (language-aware)
      const title = document.createElement('h2');
      const isEnglishHeader = (localStorage.getItem('preferredLanguage') || 'zh') === 'en';
      title.textContent = isEnglishHeader ? 'Risk Assessment for Different Dental Treatments' : 'ä¸åŒç‰™ç§‘æ²»ç™‚çš„é¢¨éšªè©•ä¼°';
      resultsContainer.appendChild(title);
      
      // Add general oral hygiene instructions section
      addGeneralHygieneSection(resultsContainer);
      
      // Add reference papers link
      const referenceLink = document.createElement('div');
      referenceLink.style.cssText = 'text-align: center; margin: 20px 0;';
      referenceLink.innerHTML = `
        <a href="reference-papers.html" style="
          display: inline-block;
          background: #007AFF;
          color: white;
          padding: 12px 24px;
          border-radius: 25px;
          text-decoration: none;
          font-weight: bold;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
          transition: all 0.3s ease;
        " onmouseover="this.style.background='#0056b3'; this.style.transform='translateY(-2px)'" 
           onmouseout="this.style.background='#007AFF'; this.style.transform='translateY(0)'">
          ${isEnglishHeader ? 'View Full Reference Papers' : 'æŸ¥çœ‹å®Œæ•´æ–‡ç»åƒè€ƒè³‡æ–™'}
        </a>
      `;
      resultsContainer.appendChild(referenceLink);
      
      assessments.forEach(assessment => {
        const card = document.createElement('div');
        card.className = 'assessment-card';
        
        const procedureTitle = document.createElement('h3');
        procedureTitle.className = 'procedure-title';
        
        // Check current language from localStorage
        const isEnglish = localStorage.getItem('preferredLanguage') === 'en';
        
        if (isEnglish) {
          procedureTitle.textContent = assessment.procedureEn;
        } else {
          procedureTitle.textContent = assessment.procedure;
        }
        
        // Add treatment types description
        const treatmentTypesDesc = document.createElement('div');
        treatmentTypesDesc.className = 'treatment-types-desc';
        treatmentTypesDesc.style.cssText = 'font-size: 1em; color: #666; margin: 5px 0 10px 0; font-style: italic;';
        
        // Use the same language check variable
        
        if (isEnglish) {
          treatmentTypesDesc.textContent = `Treatment Types: ${assessment.categoryDescriptionEn}`;
        } else {
          treatmentTypesDesc.textContent = `æ²»ç™‚ç¨®é¡: ${assessment.categoryDescription}`;
        }
        
        const riskBadge = document.createElement('span');
        riskBadge.className = 'risk-badge';
        
        // Translate risk level for display
        const riskLevelTranslations = {
          'ä½é¢¨éšª': 'Low Risk',
          'ä¸­ä½é¢¨éšª': 'Medium-Low Risk',
          'ä¸­åº¦é¢¨éšª': 'Medium Risk',
          'ä¸­é«˜é¢¨éšª': 'Medium-High Risk',
          'é«˜é¢¨éšª': 'High Risk',
          'è³‡æ–™ä¸è¶³': 'Insufficient Data'
        };
        
        riskBadge.textContent = isEnglish ? 
          (riskLevelTranslations[assessment.riskLevel] || assessment.riskLevel) : 
          assessment.riskLevel;
        
      // Set color based on risk level (supports mid-low/mid-high)
      if (assessment.riskLevel === 'é«˜é¢¨éšª') {
        riskBadge.classList.add('high-risk');
      } else if (assessment.riskLevel === 'ä¸­é«˜é¢¨éšª') {
        riskBadge.classList.add('midhigh-risk');
      } else if (assessment.riskLevel === 'ä¸­åº¦é¢¨éšª') {
        riskBadge.classList.add('medium-risk');
      } else if (assessment.riskLevel === 'ä¸­ä½é¢¨éšª') {
        riskBadge.classList.add('midlow-risk');
      } else if (assessment.riskLevel === 'è³‡æ–™ä¸è¶³') {
        riskBadge.classList.add('unknown-risk');
      } else {
        riskBadge.classList.add('low-risk');
      }
        
        const recommendation = document.createElement('p');
        recommendation.className = 'recommendation';
        recommendation.style.whiteSpace = 'pre-line'; // Preserve line breaks
        recommendation.innerHTML = isEnglish ? assessment.recommendationEn : assessment.recommendation;
        
        // Add incidence rate if available
        let incidenceInfo = '';
        if (assessment.incidenceRate !== undefined && assessment.incidenceRate !== null && assessment.incidenceRate !== 'N/A') {
          incidenceInfo = document.createElement('div');
          incidenceInfo.style.cssText = 'margin: 10px 0; padding: 8px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;';
          let rateText = `${assessment.incidenceRate}%`;
          if (assessment.hasLimitedData) {
            rateText += ' <span style="color: #ff9800; font-weight: bold;">**</span>';
          }
          const incidenceLabel = isEnglish ? 'Statistical Incidence:' : 'çµ±è¨ˆç™¼ç”Ÿç‡:';
          incidenceInfo.innerHTML = `<strong>${incidenceLabel}</strong> ${rateText}`;
        }
        
        // Add limited data warning if applicable
        let limitedDataWarning = '';
        if (assessment.hasLimitedData) {
          limitedDataWarning = document.createElement('div');
          limitedDataWarning.style.cssText = 'margin: 10px 0; padding: 8px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; font-size: 0.85em; color: #856404;';
          const warningText = isEnglish ? 
            '<strong>âš ï¸ Limited Data Warning:</strong> This incidence rate is based on limited research data. Please interpret results with caution and consult a healthcare professional.' :
            '<strong>âš ï¸ è³‡æ–™é™åˆ¶æé†’:</strong> æ­¤ç™¼ç”Ÿç‡åŸºæ–¼æœ‰é™çš„ç ”ç©¶è³‡æ–™ï¼Œå»ºè­°è¬¹æ…è§£è®€çµæœä¸¦è«®è©¢å°ˆæ¥­é†«å¸«é€²è¡Œé€²ä¸€æ­¥è©•ä¼°ã€‚';
          limitedDataWarning.innerHTML = warningText;
        }
        
        // Add reference papers link if available (skip for semi-invasive treatments)
        let referenceLink = '';
        if (assessment.references && assessment.references.length > 0 && assessment.invasiveness !== 'semiInvasive') {
          const indication = getIndicationForReference(patientData);
          const invasive = assessment.invasiveness === 'invasive';
          const patientName = patientData.name || 'æ‚£è€…';
          
          // Check if we have multiple medications with same risk level
          if (patientData.highestRiskMedications && patientData.highestRiskMedications.length > 1) {
            // Show references for all highest-risk medications
            referenceLink = document.createElement('div');
            referenceLink.style.cssText = 'margin: 10px 0; text-align: right;';
            
            let referenceLinks = [];
            patientData.highestRiskMedications.forEach((med, index) => {
              const medication = med.drugName;
              const route = getRouteForReference({ 
                hasAntiresorptiveMed: true, 
                administrationRoute: med.administrationRoute 
              });
              
              const referenceFileName = getReferenceFileName(indication, medication, route, invasive);
              const referenceUrl = `${referenceFileName}?name=${encodeURIComponent(patientName)}`;
              
              referenceLinks.push(`
                <a href="${referenceUrl}" style="
                  color: #007AFF;
                  text-decoration: none;
                  font-size: 0.9em;
                  font-weight: bold;
                  margin-left: 10px;
                " onmouseover="this.style.textDecoration='underline'" 
                   onmouseout="this.style.textDecoration='none'">
                  ${medication} (${route})
                </a>
              `);
            });
            
            const referenceText = isEnglish ? 
              `Related Literature (${assessment.references.length} articles) - Multiple medications with same risk level:` :
              `ç›¸é—œæ–‡ç» (${assessment.references.length}ç¯‡) - å¤šç¨®è—¥ç‰©åŒé¢¨éšªç­‰ç´š:`;
            referenceLink.innerHTML = `
              <div style="margin-bottom: 5px; font-size: 0.9em; color: #666;">
                ${referenceText}
              </div>
              ${referenceLinks.join('')}
            `;
          } else {
            // Single medication or primary medication
            const medication = getMedicationForReference(patientData);
            const route = getRouteForReference(patientData);
            
            const referenceFileName = getReferenceFileName(indication, medication, route, invasive);
            const referenceUrl = `${referenceFileName}?name=${encodeURIComponent(patientName)}`;
            
            referenceLink = document.createElement('div');
            referenceLink.style.cssText = 'margin: 10px 0; text-align: right;';
            const linkText = isEnglish ? 
              `View Related Literature (${assessment.references.length} articles)` :
              `æŸ¥çœ‹ç›¸é—œæ–‡ç» (${assessment.references.length}ç¯‡)`;
            referenceLink.innerHTML = `
              <a href="${referenceUrl}" style="
                color: #007AFF;
                text-decoration: none;
                font-size: 0.9em;
                font-weight: bold;
              " onmouseover="this.style.textDecoration='underline'" 
                 onmouseout="this.style.textDecoration='none'">
                ${linkText}
              </a>
            `;
          }
        }
        
        card.appendChild(procedureTitle);
        card.appendChild(treatmentTypesDesc);
        card.appendChild(riskBadge);
        if (incidenceInfo) card.appendChild(incidenceInfo);
        if (limitedDataWarning) card.appendChild(limitedDataWarning);
        card.appendChild(recommendation);
        if (referenceLink) card.appendChild(referenceLink);
        
        resultsContainer.appendChild(card);
      });
      
      // Check if we have semi-invasive or invasive procedures
      const hasSemiInvasive = assessments.some(a => a.invasiveness === 'semiInvasive');
      const hasInvasive = assessments.some(a => a.invasiveness === 'invasive');
      
      // Add specific instructions based on treatment types
      if (hasInvasive) {
        addInvasiveInstructions(resultsContainer);
      }
      
      // Add references section at the end
      addReferencesSection(resultsContainer);
    }
    
    // Function to add general oral hygiene instructions
    function addGeneralHygieneSection(container) {
      const isEnglish = (localStorage.getItem('preferredLanguage') || 'zh') === 'en';
      
      const hygieneSection = document.createElement('div');
      hygieneSection.className = 'hygiene-section';
      hygieneSection.style.cssText = 'background-color: #e8f5e9; border-radius: 10px; padding: 20px; margin: 20px 0; border-left: 4px solid #4caf50;';
      
      const title = document.createElement('h3');
      title.style.cssText = 'color: #2e7d32; margin-top: 0;';
      title.innerHTML = isEnglish ? 
        'ğŸ“‹ General Oral Hygiene Instructions' : 
        'ğŸ“‹ ä¸€èˆ¬å£è…”è¡›ç”ŸæŒ‡å°';
      
      const instructionsList = document.createElement('ul');
      instructionsList.style.cssText = 'line-height: 1.8; margin: 10px 0;';
      
      const instructions = [
        {
          zh: 'è«‹å‹™å¿…å‘ŠçŸ¥æ‰€æœ‰é†«ç™‚ç…§è­·äººå“¡ï¼ˆå¦‚è…«ç˜¤ç§‘é†«å¸«ã€å…§åˆ†æ³Œç§‘é†«å¸«ã€ç‰™é†«å¸«ï¼‰æ‚¨ç›®å‰æˆ–æ›¾ä½¿ç”¨æŠ—éª¨å¸æ”¶è—¥ç‰©ã€‚',
          en: 'Inform all your healthcare providers (oncologists, endocrinologists, dentists) about your medication history.'
        },
        {
          zh: 'æ¯å¤©è‡³å°‘åˆ·ç‰™å…©æ¬¡ï¼Œä½¿ç”¨è»Ÿæ¯›ç‰™åˆ·åŠå«æ°Ÿç‰™è†ï¼ˆæ°Ÿæ¿ƒåº¦ >1000 ppmï¼‰ï¼Œä¸¦åœ¨åˆ·ç‰™å‰ä½¿ç”¨ç‰™ç·šã€‚',
          en: 'Brush at least twice daily using a soft-bristled toothbrush and fluoride toothpaste (>1000 ppm), use dental floss before brushing.'
        },
        {
          zh: 'è‹¥ç‰™é†«å¸«å»ºè­°ï¼Œè«‹ä½¿ç”¨ç‰™é–“åˆ·æ¸…æ½”ç‰™é½’é„°æ¥é¢ã€‚',
          en: 'Use interdental brushes if instructed by your dentist.'
        },
        {
          zh: 'è«‹æ¯3â€“6å€‹æœˆå®šæœŸåšç‰™ç§‘æª¢æŸ¥èˆ‡æ´—ç‰™ã€‚',
          en: 'Have dental checkup and teeth scaling every 3â€“6 months.'
        },
        {
          zh: 'è‹¥å‡ºç¾ç‰™é½¦ç–¼ç—›ã€è…«è„¹æˆ–éª¨é ­å¤–éœ²ç­‰æƒ…å½¢ï¼Œè«‹ç«‹å³é€šçŸ¥ç‰™é†«å¸«ã€‚',
          en: 'Inform your dentist if there is gum pain, swelling, or exposed bone.'
        },
        {
          zh: 'æ§åˆ¶ç³–å°¿ç—…ã€æˆ’è¸ä¸¦ä¿æŒå‡è¡¡ç‡Ÿé¤Šï¼Œæœ‰åŠ©æ–¼ä¿ƒé€²å£è…”åŠéª¨éª¼å¥åº·ã€‚',
          en: 'Be sure to control diabetes, stop smoking, and maintain balanced nutrition.'
        },
        {
          zh: 'è«‹å‹¿è‡ªè¡Œåœç”¨æŠ—éª¨å¸æ”¶è—¥ç‰©ï¼›å¦‚éœ€æš«åœç”¨è—¥ï¼ˆè—¥ç‰©å‡æœŸï¼‰ï¼Œæ‡‰èˆ‡é–‹ç«‹è—¥ç‰©çš„é†«å¸«å…±åŒè¨è«–ä¸¦ä¾å…¶å»ºè­°é€²è¡Œã€‚',
          en: 'Do not self-discontinue anti-resorptive medication; any drug holiday should be coordinated with the prescribing physician.'
        }
      ];
      
      instructions.forEach(instruction => {
        const li = document.createElement('li');
        li.textContent = isEnglish ? instruction.en : instruction.zh;
        instructionsList.appendChild(li);
      });
      
      hygieneSection.appendChild(title);
      hygieneSection.appendChild(instructionsList);
      container.appendChild(hygieneSection);
    }
    
    // Function to add invasive treatment specific instructions
    function addInvasiveInstructions(container) {
      const isEnglish = (localStorage.getItem('preferredLanguage') || 'zh') === 'en';
      
      const invasiveSection = document.createElement('div');
      invasiveSection.className = 'invasive-section';
      invasiveSection.style.cssText = 'background-color: #ffebee; border-radius: 10px; padding: 20px; margin: 20px 0; border-left: 4px solid #f44336;';
      
      const title = document.createElement('h3');
      title.style.cssText = 'color: #c62828; margin-top: 0;';
      title.innerHTML = isEnglish ? 
        'ğŸš¨ Invasive Treatment Specific Instructions' : 
        'ğŸš¨ ä¾µå…¥æ€§æ²»ç™‚ï¼ˆå¦‚æ‹”ç‰™ã€æ¤ç‰™ã€è£œéª¨æ‰‹è¡“ç­‰ï¼‰ç‰¹åˆ¥æŒ‡å°';
      
      const content = document.createElement('div');
      content.style.cssText = 'line-height: 1.8;';
      
      if (isEnglish) {
        content.innerHTML = `
          <h4 style="color: #c62828; margin-top: 10px;">Preoperative</h4>
          <ul>
            <li>Antibiotic prophylaxis: Follow dentist's prescription (commonly started 1 day before surgery).</li>
            <li>Confirm with prescribing physician whether temporary suspension of anti-resorptive medication is appropriate.</li>
          </ul>
          
          <h4 style="color: #c62828; margin-top: 15px;">Wound Care</h4>
          <ul>
            <li>Apply cold compress in the first 24 hours to minimize swelling.</li>
            <li>Do not smoke, spit forcefully, or use straws for the first week.</li>
            <li><strong>Diet:</strong> Soft, lukewarm foods for several days.</li>
            <li><strong>Pain and infection control:</strong> Complete the full course of antibiotics and analgesics as prescribed.</li>
          </ul>
          
          <h4 style="color: #c62828; margin-top: 15px;">Follow-up</h4>
          <ul>
            <li>Schedule wound check at 1 week, then every 2â€“4 weeks until mucosal healing is complete.</li>
          </ul>
          
          <h4 style="color: #c62828; margin-top: 15px;">Inform your dentist if:</h4>
          <ul>
            <li>Persistent pain or swelling beyond one week</li>
            <li>Exposed bone or ulcer that doesn't heal after 8 weeks</li>
            <li>Numbness or tingling in jaw/lip area</li>
          </ul>
        `;
      } else {
        content.innerHTML = `
          <h4 style="color: #c62828; margin-top: 10px;">æ‰‹è¡“å‰ï¼ˆPreoperativeï¼‰</h4>
          <ul>
            <li><strong>é é˜²æ€§æŠ—ç”Ÿç´ ï¼š</strong> è«‹ä¾ç‰™é†«å¸«è™•æ–¹æœç”¨ï¼Œé€šå¸¸æ–¼æ‰‹è¡“å‰ä¸€å¤©é–‹å§‹ã€‚</li>
            <li>è«‹èˆ‡é–‹ç«‹è—¥ç‰©çš„é†«å¸«ç¢ºèªæ˜¯å¦éœ€è¦æš«åœæŠ—éª¨å¸æ”¶è—¥ç‰©ï¼ˆè—¥ç‰©å‡æœŸï¼‰ã€‚</li>
          </ul>
          
          <h4 style="color: #c62828; margin-top: 15px;">å‚·å£ç…§è­·ï¼ˆWound Careï¼‰</h4>
          <ul>
            <li>æ‰‹è¡“å¾Œ24å°æ™‚å…§å†°æ•·ï¼Œä»¥æ¸›å°‘è…«è„¹ã€‚</li>
            <li>æ‰‹è¡“å¾Œä¸€å€‹æ˜ŸæœŸè«‹é¿å…æŠ½è¸ã€ç”¨åŠ›åå£æ°´æˆ–ä½¿ç”¨å¸ç®¡ã€‚</li>
            <li><strong>é£²é£Ÿï¼š</strong> è«‹é£Ÿç”¨æŸ”è»Ÿã€æº«æ¶¼çš„é£Ÿç‰©æ•¸æ—¥ï¼Œé¿å…éç†±æˆ–åˆºæ¿€æ€§é£Ÿç‰©ã€‚</li>
            <li><strong>ç–¼ç—›èˆ‡æ„ŸæŸ“æ§åˆ¶ï¼š</strong> è«‹å®Œæ•´æœç”¨é†«å¸«é–‹ç«‹çš„æŠ—ç”Ÿç´ èˆ‡æ­¢ç—›è—¥ï¼Œä¸è¦è‡ªè¡Œåœè—¥ã€‚</li>
          </ul>
          
          <h4 style="color: #c62828; margin-top: 15px;">è¡“å¾Œè¿½è¹¤</h4>
          <ul>
            <li>è«‹æ–¼æ‰‹è¡“å¾Œ1é€±å›è¨ºæª¢æŸ¥å‚·å£ï¼Œä¹‹å¾Œæ¯2â€“4é€±è¿½è¹¤ä¸€æ¬¡ï¼Œç›´åˆ°é»è†œå®Œå…¨ç™’åˆç‚ºæ­¢ã€‚</li>
          </ul>
          
          <h4 style="color: #c62828; margin-top: 15px;">è‹¥å‡ºç¾ä¸‹åˆ—æƒ…æ³ï¼Œè«‹ç«‹å³å‘ŠçŸ¥ç‰™é†«å¸«ï¼š</h4>
          <ul>
            <li>ç–¼ç—›æˆ–è…«è„¹æŒçºŒè¶…é1é€±æœªæ”¹å–„ã€‚</li>
            <li>å£å…§éª¨é ­å¤–éœ²æˆ–æ½°ç˜8é€±ä»¥ä¸Šä»æœªç™’åˆã€‚</li>
            <li>ä¸‹å·´æˆ–å˜´å”‡å‡ºç¾éº»æœ¨æˆ–åˆºç—›æ„Ÿã€‚</li>
          </ul>
        `;
      }
      
      invasiveSection.appendChild(title);
      invasiveSection.appendChild(content);
      container.appendChild(invasiveSection);
    }
    
    // Function to add references section
    function addReferencesSection(container) {
      const isEnglish = (localStorage.getItem('preferredLanguage') || 'zh') === 'en';
      
      const referencesSection = document.createElement('div');
      referencesSection.className = 'references-section';
      referencesSection.style.cssText = 'background-color: #f5f5f5; border-radius: 10px; padding: 20px; margin: 20px 0; border-left: 4px solid #757575;';
      
      const title = document.createElement('h3');
      title.style.cssText = 'color: #424242; margin-top: 0;';
      title.innerHTML = isEnglish ? 
        'ğŸ“š References' : 
        'ğŸ“š åƒè€ƒè³‡æ–™';
      
      const referencesList = document.createElement('ol');
      referencesList.style.cssText = 'line-height: 1.8; margin: 10px 0; padding-left: 20px;';
      
      const references = [
        {
          zh: 'Ruggiero SLã€Dodson TBã€Aghaloo TLã€Carlson ERã€Ward BBã€Kademani Dã€‚ã€ˆAmerican Association of Oral and Maxillofacial Surgeons\' Position Paper on Medication-Related Osteonecrosis of the Jawsâ€”2022 Updateã€‰ã€‚Journal of Oral and Maxillofacial Surgeryã€‚2022ï¼›80(5)ï¼š920â€“943ã€‚',
          en: 'Ruggiero SL, Dodson TB, Aghaloo TL, Carlson ER, Ward BB, Kademani D. American Association of Oral and Maxillofacial Surgeons\' Position Paper on Medication-Related Osteonecrosis of the Jawsâ€”2022 Update. Journal of Oral and Maxillofacial Surgery. 2022;80(5):920â€“943.'
        },
        {
          zh: 'è¡›ç”Ÿç¦åˆ©éƒ¨å£è…”å¥åº·å¸ã€‚ã€Šæˆäººå£è…”ä¿å¥å°ˆæ¥­ç‰ˆæ‰‹å†Šã€‹ã€‚è‡ºåŒ—å¸‚ï¼šè¡›ç”Ÿç¦åˆ©éƒ¨ã€‚',
          en: 'Department of Oral Health, Ministry of Health and Welfare (Taiwan). Adult Oral Health Professional Manual. Taipei: Ministry of Health and Welfare, R.O.C.'
        },
        {
          zh: 'è¡›ç”Ÿç¦åˆ©éƒ¨å£è…”å¥åº·å¸ã€‚ã€Šå£è…”æ°ŸåŒ–ç‰©ä¹‹æ‡‰ç”¨èˆ‡æ¨å»£æ‰‹å†Šã€‹ã€‚è‡ºåŒ—å¸‚ï¼šè¡›ç”Ÿç¦åˆ©éƒ¨ã€‚',
          en: 'Department of Oral Health, Ministry of Health and Welfare (Taiwan). Manual for the Application and Promotion of Oral Fluoride Use. Taipei: Ministry of Health and Welfare, R.O.C.'
        },
        {
          zh: 'Newman MGã€Takei HHã€Klokkevold PRã€Carranza FAã€‚ã€ŠNewman and Carranza\'s Clinical Periodontologyã€‹ã€‚ç¬¬13ç‰ˆã€‚è–è·¯æ˜“ï¼šElsevier Saundersï¼Œ2018ã€‚',
          en: 'Newman MG, Takei HH, Klokkevold PR, Carranza FA. Newman and Carranza\'s Clinical Periodontology. 13th ed. St. Louis: Elsevier Saunders; 2018.'
        }
      ];
      
      references.forEach(reference => {
        const li = document.createElement('li');
        li.style.cssText = 'margin-bottom: 10px;';
        li.textContent = isEnglish ? reference.en : reference.zh;
        referencesList.appendChild(li);
      });
      
      referencesSection.appendChild(title);
      referencesSection.appendChild(referencesList);
      container.appendChild(referencesSection);
    }
    
    // Helper function to get medication for reference URL
    function getMedicationForReference(patientData) {
      if (!patientData.hasAntiresorptiveMed) {
        return 'none';
      }
      
      // Check medications array first (for multiple medications)
      if (patientData.medications && patientData.medications.length > 0) {
        return patientData.medications[0].drugName;
      }
      
      // Fallback to legacy drugName field
      return patientData.drugName || 'none';
    }
    
    // Helper function to get route for reference URL
    function getRouteForReference(patientData) {
      if (!patientData.hasAntiresorptiveMed) {
        return 'not_specific';
      }
      
      // Check medications array first (for multiple medications)
      if (patientData.medications && patientData.medications.length > 0) {
        const route = patientData.medications[0].administrationRoute;
        
        // Map Chinese route names to algorithm format
        if (route === 'å£æœ') return 'oral';
        if (route === 'æ³¨å°„') return 'IV/SC';
        
        // Return as-is if already in correct format
        return route || 'not_specific';
      }
      
      // Fallback to legacy administrationRoute field
      const route = patientData.administrationRoute;
      
      // Map Chinese route names to algorithm format
      if (route === 'å£æœ') return 'oral';
      if (route === 'æ³¨å°„') return 'IV/SC';
      
      // Return as-is if already in correct format
      return route || 'not_specific';
    }
    
    // Helper function to get indication for reference URL
    function getIndicationForReference(patientData) {
      // Check if patient has cancer
      if (patientData.hasCancer) {
        return 'cancer';
      }
      
      // Check medications for indication
      if (patientData.medications && patientData.medications.length > 0) {
        const firstMed = patientData.medications[0];
        if (firstMed.indication === 'éª¨è½‰ç§»' || firstMed.indication === 'å¤šç™¼æ€§éª¨é«“ç˜¤') {
          return 'cancer';
        }
        if (firstMed.indication === 'éª¨è³ªç–é¬†') {
          return 'osteoporosis';
        }
      }
      
      // Check legacy indication field
      if (patientData.indication === 'éª¨è½‰ç§»' || patientData.indication === 'å¤šç™¼æ€§éª¨é«“ç˜¤') {
        return 'cancer';
      }
      if (patientData.indication === 'éª¨è³ªç–é¬†') {
        return 'osteoporosis';
      }
      
      // Default to osteoporosis if no clear indication
      return 'osteoporosis';
    }
    
    // Helper function to generate the correct reference file name
    function getReferenceFileName(indication, medication, route, invasive) {
      // Handle special cases for medication names
      let medicationKey = medication;
      
      // Map specific bisphosphonates to general bisphosphonate category for file naming
      const specificBisphosphonates = ['Alendronate', 'Risedronate', 'Ibandronate', 'Clodronate', 'Zoledronate', 'Pamidronate'];
      if (specificBisphosphonates.includes(medication)) {
        medicationKey = 'bisphosphonate';
      }
      
      // Handle Romosuzumab vs Romosozumab naming inconsistency
      if (medication === 'Romosozumab') {
        medicationKey = 'Romosuzumab';
      }
      
      // Special case: Cancer bisphosphonates use integrated files (no route in filename)
      if (indication === 'cancer' && medicationKey === 'bisphosphonate') {
        const invasiveKey = invasive ? 'invasive' : 'noninvasive';
        return `reference-${indication}-${medicationKey}-${invasiveKey}.html`;
      }
      
      // Map route names to file naming convention
      let routeKey = route;
      if (route === 'oral') {
        routeKey = 'oral';
      } else if (route === 'IV/SC') {
        routeKey = 'IV-SC';
      } else {
        routeKey = 'not_specific';
      }
      
      // Map invasive status to file naming convention
      const invasiveKey = invasive ? 'invasive' : 'noninvasive';
      
      // Generate the file name
      if (medicationKey === 'none') {
        // For no medication cases, use a general reference
        return 'reference-papers.html';
      }
      
      return `reference-${indication}-${medicationKey}-${routeKey}-${invasiveKey}.html`;
    }
  </script>
</body>
</html> 