<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>口腔衛生指導 - MRONJ風險評估</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    .font-size-selector {
      display: flex;
      justify-content: center;
      margin-bottom: 25px;
      margin-top: 20px;
    }
    
    .font-size-btn {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      color: #212529;
      padding: 8px 15px;
      margin: 0 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    
    .font-size-btn.active {
      background-color: #007AFF;
      color: white;
      border-color: #007AFF;
    }
    
    .font-size-btn[data-size="normal"] {
      font-size: 16px;
      font-weight: bold;
    }
    
    .font-size-btn[data-size="big"] {
      font-size: 20px;
      font-weight: bold;
    }
    
    .font-size-btn[data-size="bigger"] {
      font-size: 24px;
      font-weight: bold;
    }
    
    .normal-font .page-content {
      font-size: 16px;
      line-height: 1.6;
    }
    
    .big-font .page-content {
      font-size: 20px;
      line-height: 1.8;
    }
    
    .bigger-font .page-content {
      font-size: 24px;
      line-height: 2;
    }
    
    .subtitle {
      color: #666;
      font-size: 16px;
      margin-bottom: 20px;
    }
    
    .instruction-section {
      margin-bottom: 30px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #007AFF;
    }
    
    .instruction-section h2 {
      margin-top: 0;
      color: #007AFF;
      font-size: 22px;
      margin-bottom: 15px;
    }
    
    .instruction-list {
      padding-left: 20px;
    }
    
    .instruction-list li {
      margin-bottom: 10px;
    }
    
    .priority-tag {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      margin-right: 10px;
      color: white;
    }
    
    .high-priority {
      background-color: #ff3b30;
    }
    
    .medium-priority {
      background-color: #ff9500;
    }
    
    .recommendation-card {
      background-color: #f5f5f5;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
    }
    
    .recommendation-icon {
      width: 50px;
      height: 50px;
      background-color: #007AFF;
      border-radius: 50%;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      margin-right: 20px;
      flex-shrink: 0;
    }
    
    .recommendation-text {
      flex-grow: 1;
    }
    
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }
    
    .btn {
      padding: 12px 20px;
      border-radius: 5px;
      border: none;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      min-width: 150px;
      text-align: center;
      text-decoration: none;
    }
    
    .btn-primary {
      background-color: #007AFF;
      color: white;
    }
    
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    
    .important-note {
      background-color: #ffe8e8;
      border-left: 4px solid #ff3b30;
      padding: 15px;
      margin: 30px 0;
      border-radius: 10px;
    }
    
    .important-note h3 {
      margin-top: 0;
      color: #ff3b30;
    }
  </style>
</head>
<body>
  <div class="container normal-font">
    <div class="font-size-selector">
      <button class="font-size-btn active" data-size="normal">
        <span class="zh-text">正常</span>
        <span class="en-text" style="display: none;">Normal</span>
      </button>
      <button class="font-size-btn" data-size="big">
        <span class="zh-text">大</span>
        <span class="en-text" style="display: none;">Big</span>
      </button>
      <button class="font-size-btn" data-size="bigger">
        <span class="zh-text">特大</span>
        <span class="en-text" style="display: none;">Bigger</span>
      </button>
    </div>
    
    <header>
      <h1 class="zh-text">開始使用抗骨質再吸收藥物前的口腔評估建議</h1>
      <h1 class="en-text" style="display: none;">Oral Assessment Recommendations Before Starting Antiresorptive Medications</h1>
      <p class="zh-text subtitle">根據2022年美國口腔顎面外科學會(AAOMS)指南，在開始抗骨質再吸收藥物治療前，建議您進行以下口腔評估和治療</p>
      <p class="en-text subtitle" style="display: none;">According to the 2022 AAOMS guidelines, the following oral assessments and treatments are recommended before beginning antiresorptive medication therapy</p>
    </header>

    <main class="page-content">
      <!-- Add patient info section -->
      <div id="patient-info-section" class="instruction-section" style="margin-bottom: 30px;">
        <h2 class="zh-text">病患資料</h2>
        <h2 class="en-text" style="display: none;">Patient Information</h2>
        <div id="patient-details"></div>
      </div>

      <div class="instruction-section">
        <h2 class="zh-text">拔除不可修復的牙齒</h2>
        <h2 class="en-text" style="display: none;">Extraction of Non-Restorable Teeth</h2>
        <div class="zh-text">
          <span class="priority-tag high-priority">高優先</span>
          <p>在開始抗骨質再吸收藥物治療前，應評估所有不可修復的牙齒並進行拔除。這樣可以避免日後在藥物治療期間進行侵入性牙科手術。</p>
          <ul class="instruction-list">
            <li>檢查所有嚴重蛀牙、斷裂或無法治療的牙齒</li>
            <li>評估有疑問的牙齒是否能夠保留</li>
            <li>完成所有必要的拔牙手術</li>
            <li>給予足夠的傷口癒合時間 (理想情況下為2-3週)</li>
          </ul>
        </div>
        <div class="en-text" style="display: none;">
          <span class="priority-tag high-priority">High Priority</span>
          <p>Before starting antiresorptive medication therapy, all non-restorable teeth should be assessed and extracted. This helps avoid invasive dental procedures during medication treatment.</p>
          <ul class="instruction-list">
            <li>Check all severely decayed, fractured, or untreatable teeth</li>
            <li>Evaluate questionable teeth for possible retention</li>
            <li>Complete all necessary extractions</li>
            <li>Allow adequate healing time (ideally 2-3 weeks)</li>
          </ul>
        </div>
      </div>
      
      <div class="instruction-section">
        <h2 class="zh-text">治療牙周疾病</h2>
        <h2 class="en-text" style="display: none;">Treatment of Periodontal Disease</h2>
        <div class="zh-text">
          <span class="priority-tag high-priority">高優先</span>
          <p>牙周炎症是MRONJ的重要風險因素。在開始藥物治療前，應治療任何活動性牙周疾病，並建立良好的口腔衛生習慣。</p>
          <ul class="instruction-list">
            <li>完整的牙周檢查和評估</li>
            <li>進行專業潔牙去除牙結石和菌斑</li>
            <li>必要時進行深層牙周清潔</li>
            <li>建立每日的口腔衛生習慣</li>
          </ul>
        </div>
        <div class="en-text" style="display: none;">
          <span class="priority-tag high-priority">High Priority</span>
          <p>Periodontal inflammation is a significant risk factor for MRONJ. Any active periodontal disease should be treated before starting medication, and good oral hygiene habits should be established.</p>
          <ul class="instruction-list">
            <li>Complete periodontal examination and assessment</li>
            <li>Professional cleaning to remove calculus and plaque</li>
            <li>Deep periodontal cleaning if necessary</li>
            <li>Establish daily oral hygiene habits</li>
          </ul>
        </div>
      </div>
      
      <div class="instruction-section">
        <h2 class="zh-text">完成必要的根管治療</h2>
        <h2 class="en-text" style="display: none;">Complete Necessary Root Canal Treatments</h2>
        <div class="zh-text">
          <span class="priority-tag medium-priority">中優先</span>
          <p>檢查任何有症狀的牙齒或需要根管治療的牙齒，並在開始藥物治療前完成治療。</p>
          <ul class="instruction-list">
            <li>評估所有可能受感染的牙髓或根尖部位</li>
            <li>完成所有必要的根管治療</li>
            <li>確保根管治療完成並沒有持續感染</li>
          </ul>
        </div>
        <div class="en-text" style="display: none;">
          <span class="priority-tag medium-priority">Medium Priority</span>
          <p>Examine any symptomatic teeth or teeth requiring root canal treatment, and complete the treatment before starting medication.</p>
          <ul class="instruction-list">
            <li>Assess all potentially infected pulpal or periapical sites</li>
            <li>Complete all necessary root canal treatments</li>
            <li>Ensure root canal treatments are complete with no ongoing infection</li>
          </ul>
        </div>
      </div>
      
      <div class="instruction-section">
        <h2 class="zh-text">修復有問題的假牙</h2>
        <h2 class="en-text" style="display: none;">Repair Problematic Dentures</h2>
        <div class="zh-text">
          <span class="priority-tag medium-priority">中優先</span>
          <p>檢查並調整任何磨損過度的假牙或不適合的義齒，以防止口腔黏膜損傷，這可能成為骨壞露的起始點。</p>
          <ul class="instruction-list">
            <li>檢查並調整假牙的適合度</li>
            <li>修復任何可能造成口腔組織損傷的銳利邊緣</li>
            <li>如有需要進行重鋪底或製作新假牙</li>
          </ul>
        </div>
        <div class="en-text" style="display: none;">
          <span class="priority-tag medium-priority">Medium Priority</span>
          <p>Examine and adjust any worn or ill-fitting dentures to prevent mucosal injury, which could become an initiating point for bone exposure.</p>
          <ul class="instruction-list">
            <li>Check and adjust denture fit</li>
            <li>Repair any sharp edges that may cause oral tissue damage</li>
            <li>Reline or make new dentures if needed</li>
          </ul>
        </div>
      </div>
      
      <div class="important-note">
        <h3 class="zh-text">重要提醒</h3>
        <h3 class="en-text" style="display: none;">Important Note</h3>
        <p class="zh-text">研究顯示，在開始抗骨質再吸收藥物治療前進行全面的口腔評估和治療，可顯著降低日後發生MRONJ的風險。建議您在開始用藥前至少4週完成所有必要的侵入性牙科治療，讓骨組織有足夠的時間癒合。</p>
        <p class="en-text" style="display: none;">Research shows that comprehensive oral assessment and treatment before starting antiresorptive medication therapy can significantly reduce the risk of developing MRONJ later. It is recommended that you complete all necessary invasive dental treatments at least 4 weeks before starting medication to allow adequate time for bone healing.</p>
      </div>

      <div style="text-align: right; margin: 20px 0; color: #666; font-size: 14px;">
        <p class="zh-text">內容參考：AAOMS Position Paper on Medication-Related Osteonecrosis of the Jaw - 2022 Update</p>
        <p class="en-text" style="display: none;">Instruction is based on: AAOMS Position Paper on Medication-Related Osteonecrosis of the Jaw - 2022 Update</p>
      </div>
      
      <div class="action-buttons">
        <a href="medication-history.html" class="btn btn-secondary zh-text">返回</a>
        <a href="medication-history.html" class="btn btn-secondary en-text" style="display: none;">Back</a>
        
        <button id="save-pdf-btn" class="btn btn-primary zh-text">儲存衛生教育內容</button>
        <button id="save-pdf-btn-en" class="btn btn-primary en-text" style="display: none;">Save Instructions</button>
      </div>
    </main>

    <footer>
      <p class="zh-text">版本 1.0.0 | <a href="about.html">關於此工具</a></p>
      <p class="en-text" style="display: none;">Version 1.0.0 | <a href="about.html">About this tool</a></p>
    </footer>
  </div>

  <script src="assets/js/main.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Language display functionality
      const zhTexts = document.querySelectorAll('.zh-text');
      const enTexts = document.querySelectorAll('.en-text');
      
      function applyLanguagePreference() {
        // Get stored language preference
        const storedLang = localStorage.getItem('preferredLanguage') || 'zh';
        
        // Show/hide elements based on language
        if (storedLang === 'en') {
          zhTexts.forEach(el => el.style.display = 'none');
          enTexts.forEach(el => el.style.display = 'block');
        } else {
          zhTexts.forEach(el => el.style.display = 'block');
          enTexts.forEach(el => el.style.display = 'none');
        }
      }
      
      // Apply language preference when page loads
      applyLanguagePreference();
      
      // Font size selection functionality
      const fontSizeBtns = document.querySelectorAll('.font-size-btn');
      const container = document.querySelector('.container');
      
      function setFontSize(size) {
        // Remove all font size classes
        container.classList.remove('normal-font', 'big-font', 'bigger-font');
        
        // Add the selected font size class
        container.classList.add(`${size}-font`);
        
        // Update active button
        fontSizeBtns.forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.size === size) {
            btn.classList.add('active');
          }
        });
        
        // Store preference
        localStorage.setItem('fontSize', size);
        
        // Ensure language display is maintained
        applyLanguagePreference();
      }
      
      fontSizeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const size = this.dataset.size;
          setFontSize(size);
        });
      });
      
      // Set initial font size based on stored preferences
      const storedFontSize = localStorage.getItem('fontSize') || 'normal';
      setFontSize(storedFontSize);

      // Display patient information on page load
      function displayPatientInfo() {
        const patientDetails = document.getElementById('patient-details');
        const today = new Date();
        const dateStr = `${today.getFullYear()}年${(today.getMonth() + 1).toString().padStart(2, '0')}月${today.getDate().toString().padStart(2, '0')}日`;
        const storedLang = localStorage.getItem('preferredLanguage') || 'zh';
        const isZh = storedLang === 'zh';
        
        // Calculate BMI if height and weight are available
        let bmi = '';
        if (patientData.height && patientData.weight) {
          const heightInMeters = patientData.height / 100;
          bmi = (patientData.weight / (heightInMeters * heightInMeters)).toFixed(1);
        }
        
        // Format systemic conditions
        let systemicConditions = '';
        if (patientData.systemicDiseases && patientData.systemicDiseases.length > 0) {
          systemicConditions = patientData.systemicDiseases.join(', ');
        }
        
        // Get basic patient info with language-specific labels
        const patientBasicInfo = {
          assessmentDate: { 
            zh: `<p><strong>評估日期：</strong>${dateStr}</p>`,
            en: `<p><strong>Assessment Date: </strong>${dateStr}</p>`
          },
          name: {
            zh: `<p><strong>姓名：</strong>${patientData.name || '--'}</p>`,
            en: `<p><strong>Name: </strong>${patientData.name || '--'}</p>`
          },
          age: {
            zh: `<p><strong>年齡：</strong>${patientData.age || '--'} 歲</p>`,
            en: `<p><strong>Age: </strong>${patientData.age || '--'} years old</p>`
          },
          gender: {
            zh: `<p><strong>性別：</strong>${patientData.gender === 'male' ? '男' : patientData.gender === 'female' ? '女' : '其他'}</p>`,
            en: `<p><strong>Gender: </strong>${patientData.gender === 'male' ? 'Male' : patientData.gender === 'female' ? 'Female' : 'Other'}</p>`
          },
          height: {
            zh: `<p><strong>身高：</strong>${patientData.height || '--'} 公分</p>`,
            en: `<p><strong>Height: </strong>${patientData.height || '--'} cm</p>`
          },
          weight: {
            zh: `<p><strong>體重：</strong>${patientData.weight || '--'} 公斤</p>`,
            en: `<p><strong>Weight: </strong>${patientData.weight || '--'} kg</p>`
          },
          bmi: bmi ? {
            zh: `<p><strong>BMI：</strong>${bmi}</p>`,
            en: `<p><strong>BMI: </strong>${bmi}</p>`
          } : null,
          systemicConditions: {
            zh: `<p><strong>全身性疾病：</strong>${systemicConditions || '--'}</p>`,
            en: `<p><strong>Systemic Conditions: </strong>${systemicConditions || '--'}</p>`
          },
          cancer: {
            zh: `<p><strong>癌症：</strong>${patientData.hasCancer ? '是' : '否'}</p>`,
            en: `<p><strong>Cancer: </strong>${patientData.hasCancer ? 'Yes' : 'No'}</p>`
          },
          radiotherapy: {
            zh: `<p><strong>放射治療：</strong>${patientData.hasRadiotherapy ? '是' : '否'}</p>`,
            en: `<p><strong>Radiotherapy: </strong>${patientData.hasRadiotherapy ? 'Yes' : 'No'}</p>`
          }
        };
        
        // Build HTML for basic patient info
        let patientHTML = '';
        Object.values(patientBasicInfo).forEach(item => {
          if (item) {
            patientHTML += isZh ? item.zh : item.en;
          }
        });
        
        // Get medication info
        const medicationArray = [];
        
        // Check if medications exist in array format
        if (patientData.medications && patientData.medications.length > 0) {
          medicationArray.push(...patientData.medications);
        } 
        // Check if single medication exists as direct properties
        else if (patientData.hasAntiresorptiveMed && patientData.drugName) {
          medicationArray.push({
            drugName: patientData.drugName,
            indication: patientData.indication,
            administrationRoute: patientData.administrationRoute,
            frequency: patientData.frequency,
            startYear: patientData.startYear,
            startMonth: patientData.startMonth,
            isStopped: patientData.isStopped,
            stopYear: patientData.stopYear,
            stopMonth: patientData.stopMonth
          });
        }
        
        // Add medication section if we have medications
        if (medicationArray.length > 0) {
          // Add section header
          patientHTML += isZh 
            ? `<h3 style="margin-top: 15px; color: #007AFF;">藥物資訊</h3>` 
            : `<h3 style="margin-top: 15px; color: #007AFF;">Medication Information</h3>`;
          
          // Add each medication
          medicationArray.forEach((med, index) => {
            const medNumber = medicationArray.length > 1 ? `(${index + 1}) ` : '';
            const isFutureUse = document.querySelector('input[name="hasAntiresorptiveMed"][value="future"]')?.checked;
            
            // Determine if it's future medication based on possible indicators
            const isPlannedMed = (
              isFutureUse || 
              (med.startYear && new Date(`${med.startYear}-${med.startMonth || 1}`) > new Date())
            );
            
            // Create medication HTML
            patientHTML += `<div style="margin-top: 10px;">`; 
            
            if (isZh) {
              patientHTML += `
                <p><strong>${medNumber}${isPlannedMed ? '即將使用藥物名稱' : '藥物名稱'}：</strong>${med.drugName || '--'}</p>
                <p><strong>使用原因：</strong>${med.indication || '--'}</p>
                <p><strong>給藥途徑：</strong>${med.administrationRoute || '--'}</p>
                <p><strong>使用頻率：</strong>${med.frequency || '--'}</p>
                <p><strong>${isPlannedMed ? '即將開始時間' : '開始時間'}：</strong>${med.startYear || '--'}年${med.startMonth || '--'}月</p>
                ${(!isPlannedMed && med.isStopped) ? `<p><strong>停藥時間：</strong>${med.stopYear || '--'}年${med.stopMonth || '--'}月</p>` : ''}
              `;
            } else {
              patientHTML += `
                <p><strong>${medNumber}${isPlannedMed ? 'Future Medication' : 'Medication'}: </strong>${med.drugName || '--'}</p>
                <p><strong>Indication: </strong>${med.indication || '--'}</p>
                <p><strong>Administration Route: </strong>${med.administrationRoute || '--'}</p>
                <p><strong>Frequency: </strong>${med.frequency || '--'}</p>
                <p><strong>${isPlannedMed ? 'Future Start Date' : 'Start Date'}: </strong>${med.startYear || '--'}-${med.startMonth || '--'}</p>
                ${(!isPlannedMed && med.isStopped) ? `<p><strong>Stop Date: </strong>${med.stopYear || '--'}-${med.stopMonth || '--'}</p>` : ''}
              `;
            }
            
            patientHTML += `</div>`;
          });
        }
        
        patientDetails.innerHTML = patientHTML;
      }

      // Call displayPatientInfo on page load
      displayPatientInfo();

      // PDF generation functionality
      function generatePDF() {
        // Create a new container specifically for PDF content
        const pdfContainer = document.createElement('div');
        pdfContainer.className = 'pdf-content';
        pdfContainer.style.margin = '0';
        pdfContainer.style.padding = '0';
        
        // Create a document structure that ensures content starts from the top
        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'pdf-wrapper';
        contentWrapper.style.padding = '0';
        contentWrapper.style.margin = '0';
        pdfContainer.appendChild(contentWrapper);
        
        // Add title 
        const titleElement = document.createElement('h1');
        titleElement.textContent = '開始使用抗骨質再吸收藥物前的口腔評估建議';
        titleElement.style.color = '#007AFF';
        titleElement.style.textAlign = 'center';
        titleElement.style.fontSize = '24px';
        titleElement.style.margin = '0 0 20px 0';
        titleElement.style.padding = '0';
        contentWrapper.appendChild(titleElement);
        
        // Add subtitle
        const subtitleElement = document.createElement('p');
        subtitleElement.textContent = '根據2022年美國口腔顎面外科學會(AAOMS)指南，在開始抗骨質再吸收藥物治療前，建議您進行以下口腔評估和治療';
        subtitleElement.style.color = '#666';
        subtitleElement.style.textAlign = 'center';
        subtitleElement.style.fontSize = '16px';
        subtitleElement.style.margin = '0 0 20px 0';
        subtitleElement.style.padding = '0';
        contentWrapper.appendChild(subtitleElement);
        
        // Create patient info section (don't clone to avoid extra margins)
        const patientSection = document.createElement('div');
        patientSection.className = 'instruction-section patient-info-section';
        patientSection.style.margin = '0 0 20px 0';
        patientSection.style.padding = '10px';
        
        // Add patient info header
        const patientHeader = document.createElement('h2');
        patientHeader.textContent = '病患資料';
        patientHeader.style.color = '#007AFF';
        patientHeader.style.fontSize = '22px';
        patientHeader.style.margin = '0 0 15px 0';
        patientHeader.style.padding = '0';
        patientSection.appendChild(patientHeader);
        
        // Get patient details and add them to section
        const patientDetails = document.getElementById('patient-details').cloneNode(true);
        patientSection.appendChild(patientDetails);
        contentWrapper.appendChild(patientSection);
        
        // Copy all instruction sections but create optimized versions
        const instructionSections = document.querySelectorAll('.instruction-section:not(#patient-info-section)');
        instructionSections.forEach(section => {
          const cloned = section.cloneNode(true);
          cloned.style.margin = '0 0 20px 0';
          cloned.style.padding = '10px';
          contentWrapper.appendChild(cloned);
        });
        
        // Copy important note
        const importantNote = document.querySelector('.important-note').cloneNode(true);
        importantNote.style.margin = '20px 0';
        importantNote.style.padding = '10px';
        contentWrapper.appendChild(importantNote);
        
        // Add reference footer
        const referenceElement = document.createElement('div');
        referenceElement.style.textAlign = 'right';
        referenceElement.style.margin = '20px 0 0 0';
        referenceElement.style.color = '#666';
        referenceElement.style.fontSize = '14px';
        referenceElement.innerHTML = '<p>內容參考：AAOMS Position Paper on Medication-Related Osteonecrosis of the Jaw - 2022 Update</p>';
        contentWrapper.appendChild(referenceElement);
        
        // Add page footer with MRONJ branding
        const footerElement = document.createElement('div');
        footerElement.className = 'pdf-footer';
        footerElement.innerHTML = '<p>MRONJ口腔衛生指導 | 評估日期: ' + new Date().toLocaleDateString('zh-TW') + '</p>';
        footerElement.style.textAlign = 'right';
        footerElement.style.fontSize = '10px';
        footerElement.style.color = '#666';
        footerElement.style.margin = '10px 0 0 0';
        contentWrapper.appendChild(footerElement);
        
        // Apply styling for PDF
        const styleOptimizer = document.createElement('style');
        styleOptimizer.textContent = `
          @page {
            margin: 0;
            padding: 0;
          }
          html, body, .pdf-content, .pdf-wrapper {
            margin: 0 !important;
            padding: 0 !important;
            height: auto !important;
            min-height: 0 !important;
            vertical-align: top !important;
            box-sizing: border-box;
            display: block !important;
          }
          body {
            background: none !important;
          }
          .pdf-content, .pdf-wrapper {
            max-width: 100%;
          }
          .instruction-section, .important-note {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #007AFF;
            page-break-inside: avoid;
          }
          .instruction-section h2 {
            margin: 0 0 15px 0;
            color: #007AFF;
            font-size: 22px;
          }
          .instruction-list {
            padding-left: 20px;
          }
          .instruction-list li {
            margin-bottom: 10px;
          }
          .priority-tag {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-right: 10px;
            color: white;
          }
          .high-priority { background-color: #ff3b30; }
          .medium-priority { background-color: #ff9500; }
          .important-note h3 {
            margin: 0 0 10px 0;
            color: #ff3b30;
          }
          p, li {
            font-size: 16px;
            line-height: 1.6;
          }
          .font-size-selector, .action-buttons, footer { display: none; }
        `;
        pdfContainer.appendChild(styleOptimizer);
        
        // Configure PDF options
        const opt = {
          margin: 0, // No margin, use only CSS for spacing
          filename: `MRONJ_口腔衛生指導_${patientData.name || 'patient'}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { 
            scale: 2,
            useCORS: true,
            letterRendering: true,
            allowTaint: true,
            backgroundColor: '#ffffff'
          },
          jsPDF: { 
            unit: 'mm', 
            format: 'a4', 
            orientation: 'portrait',
            compress: true
          },
          pagebreak: { 
            mode: 'avoid-all',
            before: '.page-break'
          }
        };

        // Generate PDF
        html2pdf()
          .from(pdfContainer)
          .set(opt)
          .toPdf()
          .get('pdf')
          .then((pdf) => {
            // Ensure content is positioned at the top of the page
            pdf.internal.write(0, 'Tw');
            return pdf;
          })
          .save()
          .catch(error => {
            console.error('PDF generation error:', error);
            alert('PDF生成過程中出現錯誤，請重試');
          });
      }

      // Add click event listeners to the save buttons
      document.getElementById('save-pdf-btn').addEventListener('click', generatePDF);
      document.getElementById('save-pdf-btn-en').addEventListener('click', generatePDF);

      // Update patient info when language changes
      const languageObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'style') {
            displayPatientInfo();
          }
        });
      });

      // Observe language changes
      document.querySelectorAll('.zh-text, .en-text').forEach(function(element) {
        languageObserver.observe(element, { attributes: true });
      });
    });
  </script>
</body>
</html> 